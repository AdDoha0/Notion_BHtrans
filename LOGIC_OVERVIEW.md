# Логика работы Telegram бота для анализа звонков

## Исправленная архитектура

### 1. Структура модулей

```
tg_call_bot/
├── main.py                    # Точка входа, регистрация роутеров
├── share/
│   ├── usecases.py           # Общие функции (transcribe_file)
│   ├── promt_utils.py        # Работа с промптами
│   └── config.py             # Конфигурация
├── modules/
│   ├── openai/
│   │   ├── client.py         # OpenAI API клиент
│   │   └── handlers.py       # Обработчики команд /transcribe, /call_summary
│   └── notion/
│       ├── client.py         # Notion API клиент
│       ├── handlers.py       # Обработчики для работы с водителями
│       └── usecases.py       # Импорт общих функций
```

### 2. Основные функции

#### `transcribe_file` (share/usecases.py)
- Скачивает файл из Telegram
- Транскрибирует через OpenAI Whisper
- Очищает временные файлы

#### `process_audio` (modules/openai/client.py)  
- Полный цикл: скачивание → транскрибация → анализ GPT
- Принимает system_prompt для разных типов анализа

### 3. Логика работы команд

#### `/transcribe` - Транскрибация по спикерам
1. Пользователь вводит команду
2. Бот просит отправить аудио
3. Аудио обрабатывается с промптом для разделения по спикерам
4. Возвращается транскрипция в формате "Спикер 1: ..., Спикер 2: ..."

#### `/call_summary` - Анализ звонка  
1. Пользователь вводит команду
2. Бот просит отправить аудио
3. Аудио обрабатывается с промптом для анализа звонков (из promts/call_analyze/)
4. Возвращается подробный анализ звонка

#### `/drivers` → выбор водителя → отправка аудио
1. Пользователь выбирает водителя из списка Notion
2. Отправляет аудио/текст
3. Аудио транскрибируется (без GPT анализа)
4. Транскрипция сохраняется как комментарий в Notion

### 4. Исправленные проблемы

✅ **Циклические импорты**: `transcribe_file` вынесена в `share/usecases.py`
✅ **Дублирование кода**: Одна функция для транскрибации во всех модулях  
✅ **Отсутствующие обработчики**: Добавлены команды `/transcribe` и `/call_summary`
✅ **Регистрация роутеров**: OpenAI роутер подключен в main.py

### 5. Типы обработки аудио

| Команда | Транскрибация | GPT анализ | Сохранение |
|---------|---------------|------------|------------|
| `/transcribe` | ✅ | ✅ (разделение спикеров) | ❌ |
| `/call_summary` | ✅ | ✅ (анализ звонка) | ❌ |
| Комментарий к водителю | ✅ | ❌ | ✅ (в Notion) |

### 6. Поток данных

```
Telegram аудио → transcribe_file() → OpenAI Whisper → текст
                                                      ↓
[для анализа] → create_gptAnswer() → OpenAI GPT → анализ
[для комментария] → add_comment() → Notion API → сохранение
``` 